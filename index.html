<link rel="stylesheet" href="style.css">
<style>
    * {
        font-family: 'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif;
    }

    #container > div {
        width: 100%;
        height: 100%;
    }

    .centered {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);

        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .row {
        display: inline
    }

    .leaderboard button {
        margin: 4px;
        padding: 8px;
        font-size: 14px;
    }

    .leaderboards {
        gap: 10px;
    }

    .record > * {
        font-size: 20px;
    }
</style>

<div id="container">
    <div id="screen0">
        <h1>Choose mode</h1>
        <button onclick="switchScreen(1)">input</button>
        <button onclick="window.location.href = './output.html'">output</button>
    </div>
    <div id="screen1">
        <button onclick="ndisks = 4; switchScreen(2)">New trial (4)</button>
        <button onclick="ndisks = 5; switchScreen(2)">New trial (5)</button>
        <button class="small" onclick="window.location.reload()">Reload this</button>
        <button class="small" onclick="window.location.href = './sync.html'">Sync</button>
        <button class="small" onclick="document.body.requestFullscreen();">Fullscreen</button>
        <button onclick="window.location.href = './output.html'">Switch to output</button>
        <br>
        <button class="small" onclick="leaderboard1 = []; sendUpdate();" dangerous>Reset L4</button>
        <button class="small" onclick="leaderboard2 = []; sendUpdate();" dangerous>Reset L5</button>
        <button class="small" onclick="leaderboard1 = []; leaderboard2 = []; sendUpdate();" dangerous>Reset all</button>
        <button class="small" onclick="addRaw();sendUpdate();">Add raw</button>
        <button class="small" onclick="websocket.send('!regcancel')">Send !regcancel</button>
        <button class="small" onclick="const cmd = prompt('Enter command (!... for cross-node)'); if (cmd !== null) websocket.send()">Send command</button>
        <br>
        <p style="display: inline"># clients: <span id="nclients"></span></p>
        <button class="small" onclick="websocket.send('refresh-all')">Refresh all</button>
        <button class="small" onclick="websocket.send('!reload-all')">Reload all</button>
        <button class="small" onclick="websocket.send('!disconnect-all')">Disconnect all output</button>
        <button class="small" onclick="websocket.send('!toggle-l4')">Toggle L4</button>
        <button class="small" onclick="websocket.send('!toggle-l5')">Toggle L5</button>
        <button class="small" onclick="const n = prompt('Enter new height (default 7)'); if (n !== null) websocket.send(`!adjust-height-${n}`)">Adjust height</button>
        <div class="leaderboards">
            <div id="leaderboard1" class="leaderboard">Connecting to server ...</div>
            <div id="leaderboard2" class="leaderboard">Connecting to server ...</div>
        </div>
    </div>
    <div id="screen2">
        <div class="centered">
            <p>Select class</p>
            <button class="small" onclick="customName()">Custom name</button>
            <!-- Generated -->
        </div>
    </div>
    <div id="screen3">
        <div class="centered">
            <p>Select class number</p>
            <!-- Generated -->
        </div>
    </div>
    <div id="screen4">
        <div class="centered">
            <p style="font-size: 120px; font-family: Consolas, Courier, monospace" id="timer">00:00.000</p>
            <button id="timer-start-button" onclick="startTimer()">Start</button>
            <p>When finished, press anywhere to stop the timer</p>
        </div>
    </div>
    <div id=screen5>
        <div class="centered">
            <h1><span id="confirm-class"></span> <span id="confirm-classno"></span> <span class="result"></span></h1>
            <div class="row">
                <button onclick="sendNewRecord()">Confirm</button>
                <button onclick="websocket.send('!regcancel');switchScreen(1);">Cancel</button>
            </div>
        </div>
    </div>
    <div id="screen9">
        <h1>Tower of Hanoi</h1>
        <div id="leaderboard"></div>
    </div>
    
</div>

<script src="common.js"></script>
<script>
    var leaderboard1 = [];
    var leaderboard2 = [];

    function customName() {
        const custom = prompt("Enter name:");
        cls = custom;
        clsno = "";
        switchScreen(4);
        websocket.send(`!reginit-${ndisks}${custom}`);
    }

    function switchScreen(n) {
        for (const child of document.getElementById("container").children) {
            child.style.display = "none";
        }
        document.getElementById(`screen${n}`).style.display = "block";
    }

    document.addEventListener("DOMContentLoaded", () => {
        switchScreen(1);
        for (var i = 1; i <= 6; i++) {
            const row = document.createElement("div");
            row.classList.add("row");
            for (const letter of "ABCDE") {
                const btn = document.createElement("button");
                btn.innerText = `${i}${letter}`;
                if (i <= 3 && letter == "E") btn.style.opacity = 0;
                else btn.onclick = (e) => {
                    cls = e.target.innerText;
                    document.getElementById("confirm-class").innerText = cls;
                    switchScreen(3);
                }
                row.appendChild(btn);
            }
            document.getElementById("screen2").children[0].appendChild(row);
        }
        const width = 5;
        const height = 7;
        for (var i = 0; i < height; i++) {
            const row = document.createElement("div");
            row.classList.add("row");
            for (var j = 0; j < width; j++) {
                const btn = document.createElement("button");
                btn.innerText = (i * width + j + 1).toString().padStart(2, "0");
                btn.onclick = (e) => {
                    clsno = e.target.innerText;
                    document.getElementById("confirm-classno").innerText = clsno;
                    switchScreen(4);

                    websocket.send(`!reginit-${ndisks}${cls} ${clsno}`);
                }
                row.appendChild(btn);
            }
            document.getElementById("screen3").children[0].appendChild(row);
        }

        document.querySelectorAll("button[dangerous]").forEach(e => {
            e._onclick = e.onclick;
            e.onclick = () => {
                const ans = prompt("Are you sure? Type 'yes' to confirm.");
                if (ans == "yes!") {
                    e._onclick();
                }
            }
        })
    });

    // global
    var ndisks = 4;
    var startTime = 0;
    var timerInterval = 0;
    var score = 0;
    var cls = "";
    var clsno = "00";

    function sendUpdate() {
        websocket.send(JSON.stringify({
            type: "update",
            leaderboards: [leaderboard1, leaderboard2],
        }));
    }

    function pushRecord(leaderboard, name, score) {
        leaderboard.forEach((data, i) => {
            if (data.name == name) {
                if (data.score < score) score = data.score;
                leaderboard.splice(i, 1);
            }
        });
        leaderboard.push({
            name: name,
            score: score,
        });
    }

    function addRaw() {
        pushRecord(
            prompt("leaderboard 1 or 2") == "1" ? leaderboard1 : leaderboard2,
            prompt("enter name"),
            parseInt(prompt("enter score")),
        );
    }

    function sendNewRecord() {
        websocket.send("!regconfirm");
        pushRecord(ndisks == 4 ? leaderboard1 : leaderboard2, `${cls} ${clsno}`, score);
        sendUpdate();
        switchScreen(1);
    }

    function timerClickListener() {
        score = Date.now() - startTime;
        clearInterval(timerInterval);
        removeEventListener("mousedown", timerClickListener);
        removeEventListener("touchstart", timerClickListener);
        document.getElementById("timer-start-button").style.display = "block";
        websocket.send(`!regend-${score}`);
        switchScreen(5);
        document.querySelectorAll(".result").forEach(e => e.innerText = parseTime(score));
        document.getElementById("timer").innerText = "00:00.000";
    }

    function startTimer() {
        startTime = Date.now();
        timerInterval = setInterval(() => {
            document.getElementById("timer").innerText = parseTime(Date.now() - startTime);
        }, 57);
        addEventListener("mousedown", timerClickListener);
        addEventListener("touchstart", timerClickListener);
        document.getElementById("timer-start-button").style.display = "none";
        websocket.send(`!regstart`);
    }
    
    const wsUri = "wss://large-ape-25.deno.dev";
    const output = document.querySelector("#output");
    const websocket = new WebSocket(wsUri);
    
    websocket.onopen = (e) => {
        console.log("CONNECTED");
    };

    websocket.onclose = (e) => {
        console.log("DISCONNECTED");
        document.getElementById("nclients").innerText = "DISCONNECTED";
    };

    websocket.onmessage = (e) => {
        console.log(`RECEIVED: ${e.data}`);
        if (e.data.startsWith("@")) {
            if (e.data.startsWith("@nclients:")) {
                document.getElementById("nclients").innerText = e.data.slice(10);
            }
            return;
        }
        if (e.data.startsWith("!")) {
            if (e.data == "!reload-all") {
                window.location.reload();
            }
            return;
        };
        const data = JSON.parse(e.data);
        leaderboard1 = data[0];
        leaderboard2 = data[1];
        updateLeaderboards();
    };

    websocket.onerror = (e) => {
        console.log(`ERROR: ${e.data}`);
    };

    function modifyRank(leaderboard, n) {
        const name = prompt("Enter new name");
        const score = prompt(`Enter new score (int) current = ${leaderboard[n-1].score}`);
        leaderboard[n-1] = {name: name, score: parseInt(score)};
        sendUpdate();
    }

    function removeRank(leaderboard, n) {
        leaderboard.splice(n - 1, 1);
        sendUpdate();
    }
    
    function updateLeaderboard(id, leaderboard) {
        const container = document.getElementById(id);
        container.innerHTML = "";
        var rank = 1;
        for (const {name, score} of leaderboard) {
            const record = document.createElement("div");
            record.classList.add("record");
            const recordRank = document.createElement("span");
            recordRank.classList.add("record-rank");
            recordRank.innerText = rank.toString();
            const recordName = document.createElement("span");
            recordName.classList.add("record-name");
            recordName.innerText = name;
            const recordTime = document.createElement("span");
            recordTime.classList.add("record-time");
            recordTime.innerText = parseTime(score);
            record.appendChild(recordRank);
            record.appendChild(recordName);
            record.appendChild(recordTime);

            const removeButton = document.createElement("button");
            removeButton.innerText = "Del";
            removeButton._rank = rank;
            removeButton.onclick = e => removeRank(leaderboard, e.target._rank);

            const modifyButton = document.createElement("button");
            modifyButton.innerText = "Mod";
            modifyButton._rank = rank
            modifyButton.onclick = e => modifyRank(leaderboard, e.target._rank);
            
            record.appendChild(modifyButton);
            record.appendChild(removeButton);

            container.appendChild(record);

            rank++;
        }
        if (leaderboard.length == 0) {
            container.innerHTML = "<p>empty</p>";
        }
        container.style.backgroundColor = "lightgreen";
        setTimeout(() => container.style.backgroundColor = "", 300);
    }

</script>
