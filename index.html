<link rel="stylesheet" href="style.css">
<style>
    * {
        font-family: 'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif;
    }

    #container > div {
        width: 100%;
        height: 100%;
    }

    .centered {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);

        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .row {
        display: inline
    }

    #leaderboard button {
        margin: 4px;
        padding: 8px;
        font-size: 20px;
    }
</style>

<div id="container">
    <div id="screen0">
        <h1>Choose mode</h1>
        <button onclick="switchScreen(1)">input</button>
        <button onclick="window.location.href = './output.html'">output</button>
    </div>
    <div id="screen1">
        <button onclick="switchScreen(2)">Start new trial</button>
        <button class="small" onclick="websocket.send('refresh-all')">Refresh all</button>
        <button class="small" onclick="websocket.send('refresh')">Refresh this</button>
        <button class="small" onclick="websocket.send('clear')">Clear data</button>
        <button class="small" onclick="addRaw();sendUpdate();">Add raw</button>
        <p># clients: <span id="nclients"></span></p>
        <div id="leaderboard">Connecting to server ...</div>
    </div>
    <div id="screen2">
        <div class="centered">
            <p style="font-size: 120px; font-family: Consolas, Courier, monospace" id="timer">00:00.000</p>
            <button id="timer-start-button" onclick="startTimer()">Start</button>
            <p>When finished, press anywhere to stop the timer</p>
        </div>
    </div>
    <div id="screen3">
        <div class="centered">
            <p>Your time: <span class="result"></span></p>
            <p>Select class</p>
            <!-- Generated -->
        </div>
    </div>
    <div id="screen4">
        <div class="centered">
            <p>Your time: <span class="result"></span></p>
            <p>Select class number</p>
            <!-- Generated -->
        </div>
    </div>
    <div id=screen5>
        <div class="centered">
            <h1><span id="confirm-class"></span> <span id="confirm-classno"></span> <span class="result"></span></h1>
            <button onclick="sendNewRecord()">Confirm</button>
        </div>
    </div>
    <div id="screen9">
        <h1>Tower of Hanoi</h1>
        <div id="leaderboard"></div>
    </div>
    
</div>

<script src="common.js"></script>
<script>
    var leaderboard = [];

    function switchScreen(n) {
        for (const child of document.getElementById("container").children) {
            child.style.display = "none";
        }
        document.getElementById(`screen${n}`).style.display = "block";
    }

    document.addEventListener("DOMContentLoaded", () => {
        switchScreen(0);
        for (var i = 1; i <= 6; i++) {
            const row = document.createElement("div");
            row.classList.add("row");
            for (const letter of "ABCDE") {
                const btn = document.createElement("button");
                btn.innerText = `${i}${letter}`;
                if (i <= 3 && letter == "E") btn.style.opacity = 0;
                else btn.onclick = (e) => {
                    cls = e.target.innerText;
                    document.getElementById("confirm-class").innerText = cls;
                    switchScreen(4);
                }
                row.appendChild(btn);
            }
            document.getElementById("screen3").children[0].appendChild(row);
        }
        const width = 6;
        const height = 6;
        for (var i = 0; i < height; i++) {
            const row = document.createElement("div");
            row.classList.add("row");
            for (var j = 0; j < width; j++) {
                const btn = document.createElement("button");
                btn.innerText = (i * width + j).toString().padStart(2, "0");
                btn.onclick = (e) => {
                    clsno = e.target.innerText;
                    document.getElementById("confirm-classno").innerText = clsno;
                    switchScreen(5);
                }
                row.appendChild(btn);
            }
            document.getElementById("screen4").children[0].appendChild(row);
        }

    leaderboard = [
        {name: "name1", score: 199},
        {name: "name2", score: 199},
        {name: "name3", score: 199},
        {name: "name4", score: 199},
    ]

    updateLeaderboard();
    });

    // global
    var startTime = 0;
    var timerInterval = 0;
    var score = 0;
    var cls = "";
    var clsno = "00";

    function sendUpdate() {
        websocket.send(JSON.stringify({
            type: "update",
            leaderboard: leaderboard,
        }));
    }

    function pushRecord(name, score) {
        leaderboard.push({
            name: name,
            score: score,
        })
    }

    function addRaw() {
        pushRecord(
            prompt("enter name"),
            prompt("enter score"),
        );
    }

    function sendNewRecord() {
        pushRecord(`${cls} ${clsno}`, score);
        sendUpdate();
        switchScreen(1);
    }

    function timerClickListener() {
        score = Date.now() - startTime;
        clearInterval(timerInterval);
        removeEventListener("mousedown", timerClickListener);
        document.getElementById("timer-start-button").style.display = "block";
        switchScreen(3);
        document.querySelectorAll(".result").forEach(e => e.innerText = parseTime(score));
        document.getElementById("timer").innerText = "00:00.000";
    }

    function startTimer() {
        startTime = Date.now();
        timerInterval = setInterval(() => {
            document.getElementById("timer").innerText = parseTime(Date.now() - startTime);
        }, 57);
        addEventListener("mousedown", timerClickListener);
        document.getElementById("timer-start-button").style.display = "none";
    }
    
    const wsUri = "wss://large-ape-25.deno.dev";
    const output = document.querySelector("#output");
    const websocket = new WebSocket(wsUri);
    
    websocket.onopen = (e) => {
        console.log("CONNECTED");
    };

    websocket.onclose = (e) => {
        console.log("DISCONNECTED");
    };

    websocket.onmessage = (e) => {
        console.log(`RECEIVED: ${e.data}`);
        if (e.data.startsWith("@")) {
            if (e.data.startsWith("@nclients:")) {
                document.getElementById("nclients").innerText = e.data.slice(10);
            }
            return;
        }
        leaderboard = JSON.parse(e.data);
        updateLeaderboard();
    };

    websocket.onerror = (e) => {
        console.log(`ERROR: ${e.data}`);
    };

    function modifyRank(n) {
        const name = prompt("Enter new name");
        const score = prompt(`Enter new score (int) current = ${leaderboard[n-1]}`);
        leaderboard[n] = {name: name, score: score};
        sendUpdate();
    }

    function removeRank(n) {
        temp = []
        leaderboard.forEach((v, i) => {
            if (i != (n - 1)) temp.push(v);
        })
        leaderboard = temp;
        sendUpdate();
    }
    
    function updateLeaderboard() {
        const container = document.getElementById("leaderboard");
        container.innerHTML = "";
        var rank = 1;
        for (const {name, score} of leaderboard) {
            const record = document.createElement("div");
            record.classList.add("record");
            const recordRank = document.createElement("span");
            recordRank.classList.add("record-rank");
            recordRank.innerText = rank.toString();
            const recordName = document.createElement("span");
            recordName.classList.add("record-name");
            recordName.innerText = name;
            const recordTime = document.createElement("span");
            recordTime.classList.add("record-time");
            recordTime.innerText = parseTime(score);
            record.appendChild(recordRank);
            record.appendChild(recordName);
            record.appendChild(recordTime);

            const removeButton = document.createElement("button");
            removeButton.innerText = "Del";
            removeButton._rank = rank;
            removeButton.onclick = e => removeRank(e.target._rank);

            const modifyButton = document.createElement("button");
            modifyButton.innerText = "Mod";
            modifyButton._rank = rank
            modifyButton.onclick = e => modifyRank(e.target._rank);
            
            record.appendChild(removeButton);

            container.appendChild(record);

            rank++;
        }
        document.getElementById("leaderboard").style.backgroundColor = "lightgreen";
        setTimeout(() => document.getElementById("leaderboard").style.backgroundColor = "", 300);
    }

</script>
