<link rel="stylesheet" href="style.css">
<style>
    body {
        display: flex;
        flex-direction: column;
        align-items: start;
        gap: 20px;
        padding: 40px;
    }

    #msg {
        color: blue;
    }

    input[type = password] {
        height: 40px;
        width: 300px;
        padding: 10px;
        border: 3px solid red;
    }

    button {
        padding: 8px;
        margin: 4px;
        font-size: 18px;
        border-radius: 8px;
    }

    button:hover:not(:disabled) {
        opacity: 0.8;
    }

    button:disabled, button[disabled] {
        opacity: 0.4;
        cursor: auto;
    }

    .segment {
        display: inline-flex;
        flex-direction: row;
        gap: 0;
    }

    .segment > button {
        box-sizing: content-box;
        padding: 6px 12px;
        border: #322641 solid 1px;
        border-radius: 0;
        margin: 0;
        margin-left: -1px;
        font-family: "Noto Emoji", "Open Sans", "Microsoft JhengHei", dotum;
        color: #322641;
        background-color: transparent;
    }

    .segment > button:hover {
        color: white;
        background-color: #322641 !important;
        opacity: 1;
    }

    .segment > button.selected {
        background-color: rgb(179, 255, 179);
    }

    #logs {
        width: 100%;
    }

    #logs p {
        font-family: "Montserrat", monospace;
        text-overflow: ellipsis;
        white-space: nowrap;
        overflow: hidden;
    }
</style>
<body>
    <h1>Admin dashboard</h1>
    <div>
        <p>Verify your identity:</p>
        <input id="password" type="password">
        <button id="button-verify" onclick="checkAdmin()">Send to server</button>
    </div>
    <div>
        <h2 id="msg"></h2>
        <h3>Connection status: <span id="connection-status"></span></h3>
        <h3>Connection ID: <span id="connection-id"></span></h3>
        <h3>Server status: <span id="server-status" style="color: red;"></span></h3>
        <br>
        <button id="button-lock" style="background-color: red;" onclick="websocket.send('ADMIN:lock')">Lock server</button>
        <button id="button-unlock" style="background-color: green;" onclick="websocket.send('ADMIN:unlock')">Unlock server</button>
    </div>
    <div id="instance-management">
        <h2>Instance management</h2>
        <button onclick="instanceUpdate(createNewInstance)">Create new</button>
        <div id="instances" class="segment"></div>
        <button onclick="instanceUpdate(deleteInstance)">Delete an instance</button>
        <button onclick="instanceUpdate(cloneInstance)">Clone to</button>
    </div>
    <button onclick="window.location.href = './index.html'">Back to controller</button>
    <div id="logs"></div>
</body>

<script>
    const _ = (str, seed = 0) => {
        let h1 = 0xdeadbeef ^ seed, h2 = 0x41c6ce57 ^ seed;
        for (let i = 0, ch; i < str.length; i++) {
            ch = str.charCodeAt(i);
            h1 = Math.imul(h1 ^ ch, 2654435761);
            h2 = Math.imul(h2 ^ ch, 1597334677);
        }
        h1  = Math.imul(h1 ^ (h1 >>> 16), 2246822507);
        h1 ^= Math.imul(h2 ^ (h2 >>> 13), 3266489909);
        h2  = Math.imul(h2 ^ (h2 >>> 16), 2246822507);
        h2 ^= Math.imul(h1 ^ (h1 >>> 13), 3266489909);
    
        return 4294967296 * (2097151 & h2) + (h1 >>> 0);
    };
    const __ = (str) => _(str, _(str));

    
    const wsUri = "wss://large-ape-25.deno.dev";
    const websocket = new WebSocket(wsUri);

    var info = {
        connectionStatus: "not connected",
        connectionId: "unknown",
        serverStatus: "unknown",
    }

    function updateInfo() {
        document.getElementById("connection-status").innerText = info.connectionStatus;
        document.getElementById("connection-id").innerText = info.connectionId;
        document.getElementById("server-status").innerText = info.serverStatus;

        if (info.connectionId == "unknown") return;

        document.getElementById("button-lock").disabled = false;
        document.getElementById("button-unlock").disabled = false;
        if (info.serverStatus == "locked") {
            document.getElementById("button-lock").disabled = true;
        } else if (info.serverStatus == "open") {
            document.getElementById("button-unlock").disabled = true;
        }
    }

    function checkAdmin() {
        websocket.send(`ADMIN:${__(document.getElementById("password").value)}`);
    }

    function createNewInstance() {
        const name = prompt("Enter name for new instance:");
        if (name === null) return null;
        websocket.send(`ADMIN:inst-create:${name}`);
    }

    function deleteInstance() {
        const name = prompt("Enter name of instance to delete (cannot be current instance):");
        if (name === null) return null;
        websocket.send(`ADMIN:inst-delete:${name}`);
    }

    function cloneInstance() {
        const name = prompt("Enter name of clone of current:");
        if (name === null) return null;
        websocket.send(`ADMIN:inst-clone-to:${name}`);
    }

    var waiting = false;

    function waitForInstanceUpdate() {
        document.getElementById("instance-management").style.opacity = 0.5;
        waiting = true;
    }

    function instanceUpdate(func) {
        if (waiting) {
            alert("Waiting for previous write to finish ...");
            return;
        }
        const ret = func();
        if (ret === null) return;
        waitForInstanceUpdate();
        return ret;
    }

    function pushLog(msg) {
        const now = new Date();
        const timestamp = `${now.getFullYear()}-${now.getMonth().toString().padStart(2, "0")}-${now.getDate().toString().padStart(2, "0")} ${now.toLocaleTimeString("en-US", { hour12: false })}`
        const line = document.createElement("p");
        line.innerText = `[${timestamp}] ${msg}`;
        const logs = document.getElementById("logs");
        logs.prepend(line);
    }

    websocket.onopen = e => {
        console.log("CONNECTED");
        pushLog("[socket] connected")
        info.connectionStatus = "connected (not admin)";
        updateInfo();
        document.getElementById("button-verify").disabled = false;
    };

    websocket.onclose = e => {
        console.log("DISCONNECTED");
        pushLog("[socket] disconnected")
        reset();
    };

    websocket.onmessage = e => {
        console.log(`RECEIVED: ${e.data}`);
        pushLog(`[socket] received: ${e.data}`);
        if (e.data.startsWith("ADMIN:")) {
            if (e.data == "ADMIN:OVERRIDDEN") {
                websocket.close();
                document.getElementById("msg").innerText = "Session overriden - another client has connected as admin, reload to reconnect"
                return;
            } else if (e.data.startsWith("ADMIN:INSTANCES:")) {
                const instanceData = JSON.parse(e.data.slice("ADMIN:INSTANCES:".length));
                const segment = document.getElementById("instances");
                while (segment.children.length) {
                    segment.removeChild(segment.children[0]);
                }
                for (const name of instanceData["instances"]) {
                    const btn = document.createElement("button");
                    btn.innerText = name;
                    btn.value = name;
                    btn.onclick = e => instanceUpdate(() => {
                        websocket.send(`ADMIN:inst-switch:${e.target.value}`);
                    });
                    segment.appendChild(btn);
                    if (name == instanceData["current"]) {
                        btn.classList.add("selected");
                    }
                }
            } else if (e.data == "ADMIN:DONE") {
                waiting = false;
                document.getElementById("instance-management").style.opacity = 1;

            } else {
                info.connectionStatus = "connected as admin";
                const newInfo = JSON.parse(e.data.slice(6));
                info = { ...info, ...newInfo };
                updateInfo();
            }
        }
    }

    const reset = () => {
        info.connectionStatus = "disconnected";
        info.connectionId = "unknown";
        info.serverStatus = "unknown";
        updateInfo();
        document.getElementById("button-verify").disabled = true;
        document.getElementById("button-lock").disabled = true;
        document.getElementById("button-unlock").disabled = true;
    };

    document.addEventListener("DOMContentLoaded", () => {
        reset();
        info.connectionStatus = "connecting ...";
        updateInfo();
    });
</script>
