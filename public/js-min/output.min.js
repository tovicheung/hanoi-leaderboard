function parseTime(e){const t=new Date(e);return`${t.getMinutes().toString().padStart(2,"0")}:${t.getSeconds().toString().padStart(2,"0")}.${t.getMilliseconds().toString().padStart(3,"0")}`}function parseTimeStyled(e){const t=new Date(e);return`${t.getMinutes().toString().padStart(2,"0")}:${t.getSeconds().toString().padStart(2,"0")}<span class="small">.${t.getMilliseconds().toString().padStart(3,"0")}</span>`}function updateLeaderboards(){"demonslayer"==theme?(updateLeaderboardNew("lb-4",leaderboard1),updateLeaderboardNew("lb-5",leaderboard2)):(updateLeaderboard("leaderboard1",leaderboard1),updateLeaderboard("leaderboard2",leaderboard2))}function openSocket(){if(offline)return;const e="https:"===window.location.protocol?"wss:":"ws:",t=window.location.host;return(websocket=new WebSocket(`${e}//${t}/ws`)).onopen=e=>{console.log("CONNECTED"),document.getElementById("loading").style.display="none",websocket.send("REPORT-ROLE:Output"),fails=0},websocket.onmessage=socketOnMessage,websocket.onclose=e=>{if(console.log("DISCONNECTED"),fails>=MAX_TRIES)return offline=!0,document.getElementById("loading-inner").innerHTML="Offline mode",void setTimeout(()=>document.getElementById("loading").style.display="none",3e3);fails++,document.getElementById("loading-inner").innerHTML=`Disconnected.<br><br>Reconnecting ... ${fails}/${MAX_TRIES}`,document.getElementById("loading").style.display="block",setTimeout(openSocket,3e3)},websocket.onerror=e=>{console.log(`ERROR: ${e.data}`)},websocket}function startDots(){stopDots(),dotsInterval=setInterval(()=>{const e=document.getElementById("dots");e.innerText=".".repeat(e.innerText.length%3+1)},400)}function stopDots(){clearInterval(dotsInterval),document.getElementById("dots").innerText=""}function socketOnMessage(e){if(console.log(`RECEIVED: ${e.data}`),e.data.startsWith("@")){if(e.data.startsWith("@meta:")){const t=JSON.parse(e.data.slice(6));theme=t.theme}return}if(e.data.startsWith("!"))return void handleCommand(e.data);if(e.data.startsWith("AUTH:"))return;const t=JSON.parse(e.data);leaderboard1=t[0],leaderboard2=t[1],updateLeaderboards()}function appendRegName(e,t){t!=e.length+1&&(document.getElementById("banner-name").innerText=e.slice(0,t),setTimeout(()=>appendRegName(e,t+1)," "==e[t]?0:200))}function toggleDisplay(e){e.classList.contains("hidden")?e.classList.remove("hidden"):e.classList.add("hidden")}function handleCommand(e){if("!reload-all"==e)window.location.reload();else if("!disconnect-all-output"==e)websocket.close();else if("!fullscreen-all-output"==e)document.body.requestFullscreen();else if(e.startsWith("!adjust-height-")){let t=parseInt(e.slice(15));if(t<=0)return;if("gojo"==theme){height=t+(height-baseHeight),baseHeight=t,shiftPages()}else"demonslayer"==theme&&(rowsPerPage=t,document.querySelectorAll(".lb-scroll").forEach(e=>e.style.height=ROW_HEIGHT*rowsPerPage-6+"px"),updateLeaderboards())}else if("!toggle-l4"==e)toggleDisplay(document.getElementById("leaderboard1"));else if("!toggle-l5"==e)toggleDisplay(document.getElementById("leaderboard2"));else if(e.startsWith("!announcement-show:")){const t=e.slice(19);document.getElementById("announcement").innerText=t,document.getElementById("announcement").classList.remove("hidden")}else if("!announcement-hide"==e)document.getElementById("announcement").classList.add("hidden"),document.getElementById("announcement").innerText="";else if(e.startsWith("!reginit-")){const t=e[9],n=e.slice(10);document.getElementById("banner-name").innerText="",document.getElementById("banner-ndisks").innerText=t,clearInterval(regInterval),document.getElementById("banner-time").innerText="Waiting to start ",document.getElementById("banner-time").style.color="white",document.getElementById("banner").style.display="flex",startDots(),document.getElementById("banner").animate([{left:CSS.percent(-200),bottom:CSS.percent(40)},{left:0,bottom:CSS.percent(40)}],{duration:600,fill:"forwards"}),setTimeout(()=>appendRegName(n,0),500),document.getElementById("overlay").style.display="block"}else if(e.startsWith("!regstart"))regStart=Date.now(),regInterval=setInterval(()=>{document.getElementById("banner-time").innerText=parseTime(Date.now()-regStart)},57),stopDots(),timeoutToClean=setTimeout(()=>{document.getElementById("banner").animate([{bottom:CSS.percent(40)},{bottom:0}],{duration:400,fill:"forwards"}),document.getElementById("overlay").style.display="none"},1e3),height=baseHeight-1;else if(e.startsWith("!regend-")){clearInterval(regInterval);const t=parseInt(e.slice(8));document.getElementById("banner-time").innerText=parseTime(t),document.getElementById("banner-time").style.color="lime",document.getElementById("banner").animate([{bottom:0},{bottom:CSS.percent(40)}],{duration:400,fill:"forwards"}),document.getElementById("overlay").style.display="block"}else if("!regconfirm"==e)document.getElementById("banner").animate([{left:0,bottom:CSS.percent(40)},{left:CSS.percent(-200),bottom:CSS.percent(40)}],{duration:600,fill:"forwards"}),setTimeout(()=>{document.getElementById("overlay").style.display="none",document.getElementById("banner").style.display="none"},600),height=baseHeight;else if("!regcancel"==e)document.getElementById("overlay").style.display="none",document.getElementById("banner").style.display="none",stopDots(),clearTimeout(timeoutToClean),clearInterval(regInterval),height=baseHeight;else if(e.startsWith("!highlight-")){const t=JSON.parse(e.slice(11)),{id:n,name:o}=t;jumpToRecord(n,o)}}function updateLeaderboardNew(e,t){const n=document.getElementById(e);if(!n)return void console.error(`Leaderboard element with ID ${e} not found.`);leaderboardStates[e]&&leaderboardStates[e].interval&&clearInterval(leaderboardStates[e].interval);const o=t.slice(0,3),a=t.slice(3),r=a.length,l=Math.ceil(r/rowsPerPage);leaderboardStates[e]={currentPageIndex:0,totalRows:r,totalPages:l,interval:null,bottomEl:n.querySelector(".lb-bottom"),scrollEl:n.querySelector(".lb-scroll"),topEl:n.querySelector(".lb-top")};const s=leaderboardStates[e];s.topEl.innerHTML=o.map((e,t)=>renderRow(e,t+1,!0)).join(""),s.bottomEl.innerHTML=a.map((e,t)=>renderRow(e,t+4,!1)).join(""),s.bottomEl.style.transition=`transform ${ANIMATION_DURATION_MS/1e3}s ease-in-out`,0==t.length&&(s.topEl.innerHTML="<div class='lb-row'><span class='lb-row-name' style='text-align: center; color: yellow;'>Waiting for challengers ...</span></div>"),n.style.backgroundColor="rgba(0, 255, 0, 0.3)",setTimeout(()=>n.style.backgroundColor="",300),startCycle(e)}function renderRow(e,t,n){return n?`\n            <div class="lb-row">\n                <div class="lb-row-rank-top">\n                    <img class="lb-row-avatar" src="assets/${["gold","silver","bronze"][t-1]}.png">\n                    <span>${t}</span>\n                </div>\n                \x3c!-- <span class="lb-row-rank">${["&#129351;","&#129352;","&#129353;"][t-1]}</span> --\x3e\n                <span class="lb-row-name">${e.name}</span>\n                <span class="lb-row-score">${parseTimeStyled(e.score)}</span>\n            </div>\n        `:`\n        <div class="lb-row">\n            <span class="lb-row-rank">${t}</span>\n            <span class="lb-row-name">${e.name}</span>\n            <span class="lb-row-score">${parseTimeStyled(e.score)}</span>\n        </div>\n    `}function updateScrollPosition(e){const t=leaderboardStates[e];if(!t||!t.bottomEl)return;const n=t.currentPageIndex*rowsPerPage*ROW_HEIGHT;t.bottomEl.style.transform=`translateY(-${n}px)`}function cyclePages(e){const t=leaderboardStates[e];!t||t.totalPages<=1||(t.currentPageIndex>=t.totalPages-1?t.currentPageIndex=0:t.currentPageIndex++,setTimeout(()=>{updateScrollPosition(e)},500))}function startCycle(e){const t=leaderboardStates[e];updateScrollPosition(e),!t||t.totalPages<=1||(t.interval=setInterval(()=>{cyclePages(e)},1e4))}function nameToRecordNumber(e,t){let n=null;if("lb-4"===e||"leaderboard1"===e)n=leaderboard1;else{if("lb-5"!==e&&"leaderboard2"!==e)return null;n=leaderboard2}for(let e=0;e<n.length;e++)if(n[e].name===t)return e+1;return null}function jumpToRecord(e,t){const n=nameToRecordNumber(e,t);if(null===n)return void console.warn("record not found");const o=leaderboardStates[e];if(!o)return;if(!Number.isInteger(n)||n<=3)return;const a=n-4,r=Math.max(0,Math.min(Math.floor(a/rowsPerPage),Math.max(0,o.totalPages-1)));o.currentPageIndex=r,updateScrollPosition(e),setTimeout(()=>{highlightRowInBoard(o,n)},300)}function highlightRowInBoard(e,t){const n=[...e.topEl.querySelectorAll(".lb-row"),...e.bottomEl.querySelectorAll(".lb-row")].find(e=>[...e.querySelectorAll("span")].some(e=>e.textContent.trim()===String(t)));n&&(n.classList.add("record-highlight"),setTimeout(()=>n.classList.remove("record-highlight"),2e4))}function renderRecord(e,t,n,o){const a=document.createElement("div");a.classList.add("record");const r=document.createElement("span");r.classList.add("record-rank"),r.innerHTML=t<=3?["&#129351;","&#129352;","&#129353;"][t-1]:t.toString();const l=document.createElement("span");l.classList.add("record-name"),l.innerText=n;const s=document.createElement("span");s.classList.add("record-time"),s.innerText=parseTime(o),a.appendChild(r),a.appendChild(l),a.appendChild(s),e.appendChild(a)}function updateLeaderboard(e,t){const n=document.getElementById(e);if(n.innerHTML=`<h2 class="header">${id2titles[e]}</h2>`,0==t.length)n.innerHTML+="<h2>Waiting for challengers ...</h2>";else for(var o=1;o<=Math.min(3,t.length);o++){const{name:e,score:a}=t[o-1];renderRecord(n,o,e,a)}n.style.backgroundColor="lightgreen",loadPages(),setTimeout(()=>n.style.backgroundColor="",300)}function loadPage(e,t,n){for(;t.childElementCount>4;)t.removeChild(t.lastChild);for(var o=n*height+3;o<Math.min((n+1)*height+3,e.length);o++){const{name:n,score:a}=e[o];renderRecord(t,o+1,n,a)}}function loadPages(){loadPage(leaderboard1,document.getElementById("leaderboard1"),currentPages[0]),loadPage(leaderboard2,document.getElementById("leaderboard2"),currentPages[1])}function shiftPages(){const e=[leaderboard1,leaderboard2].map(e=>Math.ceil((e.length-3)/height));currentPages=currentPages.map((t,n)=>(t+1)%e[n]),loadPages()}function rand(e){let t="";const n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*()[]{}|;:,./<>?`~-=_+ ";let o=0;for(;o<e;)t+=n.charAt(Math.floor(92*Math.random())),o+=1;return t}function titleAnim2(e){-1!=e&&(document.getElementById("title").innerText=title.slice(0,24-e)+document.getElementById("title").innerText.slice(24-e),setTimeout(()=>titleAnim2(e-1),30))}function titleAnim(e){24!=e?(document.getElementById("title").innerText=rand(e),setTimeout(()=>titleAnim(e+1),30)):titleAnim2(e)}function randint(e,t){return Math.floor(Math.random()*(t-e))+e}function glowRandom(){const e=[...document.querySelectorAll(".lb-top .lb-row-score")];if(console.log(e),0!=e.length){const t=e[Math.floor(Math.random()*e.length)];t.classList.add("glow-active"),setTimeout(()=>{t.classList.remove("glow-active")},2e3)}setTimeout(glowRandom,randint(3e3,5e3))}var leaderboard1=[],leaderboard2=[],regStart=0,regInterval=0,websocket=openSocket(),fails=0;const MAX_TRIES=5;var offline=!1,theme="demonslayer";const currentUrl=new URL(window.location.href),urlParams=currentUrl.searchParams;"gojo"==urlParams.get("theme")&&(theme="gojo");const id2titles={leaderboard1:"4 disks",leaderboard2:"5 disks"};var dotsInterval=0,timeoutToClean=null;let rowsPerPage=7;const PAGE_DURATION_MS=1e4,ANIMATION_DURATION_MS=1e3,leaderboardStates={},ROW_HEIGHT=56;var baseHeight=7,height=baseHeight,currentPages=[0,0];"gojo"==theme&&setInterval(shiftPages,Math.max(5e3,900*height));const title="Tower of Hanoi Challenge";setInterval(()=>titleAnim(1),3e4),setInterval(()=>{document.getElementById("setup").style.display="none",document.body.style.cursor="none"},8e3),document.addEventListener("DOMContentLoaded",()=>{document.getElementById("title").innerText=title,document.getElementById("setup-fullscreen").onclick=()=>{document.body.requestFullscreen(),document.getElementById("setup").style.display="none",document.body.style.cursor="none"},"demonslayer"==theme?document.getElementById("lbs-gojo").style.display="none":document.getElementById("lbs-demonslayer").style.display="none"});