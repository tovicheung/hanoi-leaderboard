function parseTime(e){const t=new Date(e);return`${t.getMinutes().toString().padStart(2,"0")}:${t.getSeconds().toString().padStart(2,"0")}.${t.getMilliseconds().toString().padStart(3,"0")}`}function updateLeaderboards(){updateLeaderboard("leaderboard1",leaderboard1),updateLeaderboard("leaderboard2",leaderboard2)}function updateInfo(){document.getElementById("connection-status").innerText=info.connectionStatus,document.getElementById("input-access").innerText=serverConfig.inputAccess,document.getElementById("output-access").innerText=serverConfig.outputAccess,document.getElementById("backup-url").innerText=null===serverConfig.backupUrl?"[unset]":serverConfig.backupUrl,document.getElementById("parent-url").innerText=null===serverConfig.parentUrl?"[unset]":serverConfig.parentUrl}function modifyBackupUrl(){let e=prompt("Enter new backup url:",serverConfig.backupUrl);null!=e&&(""==e&&(e=null),configUpdate({backupUrl:e}))}function modifyParentUrl(){let e=prompt("Enter new parent url:",serverConfig.parentUrl);null!=e&&(""==e&&(e=null),configUpdate({parentUrl:e}))}async function req(e,t,n,o=!0){e.startsWith("/")&&(e=e.slice(1));const a=await fetch(`${window.location.protocol}//${window.location.host}/${e}`,{method:t,headers:{"Content-Type":"application/json",Authorization:`Bearer ${__(document.getElementById("password").value)}`},body:"GET"==t?void 0:JSON.stringify(n)});return a.ok?"GET"!=t&&(report("Success",1),waiting=!1,document.getElementById("instance-management").style.opacity=1):report(`[${a.status}] ${await a.text()}`,0,log=!0),a}function report(e,t,n=!1){let o=null==t?"gray":t?"green":"red";document.getElementById("popup").style.backgroundColor=o,document.getElementById("popup").innerText=e,document.getElementById("popup").style.display="block",setTimeout(()=>{document.getElementById("popup").style.display="none"},3e3),n&&pushLog(e)}function checkAdmin(){websocket.send(`ADMIN:${__(document.getElementById("password").value)}`)}function testConnection(){websocket.send("ping"),lastPing=Date.now()}function createNewInstance(){const e=prompt("Enter name for new instance:");if(null===e)return null;req("/api/instance/create","POST",{name:e})}function importAndOverwrite(){const e=prompt("Enter JSON of data:");if(null===e)return null;req("/api/instance/import","POST",{data:JSON.parse(e)})}async function exportData(){try{const e=await fetch("/api/data");if(!e.ok)return report("Error fetching /api/data, check console",0),void console.log(e);const t=await e.text();await navigator.clipboard.writeText(t),report("Copied JSON to clipboard!",1)}catch(e){report("Error copying data, check console",0),console.error(e)}}function deleteInstance(){const e=prompt("Enter name of instance to delete (cannot be current instance):");if(null===e)return null;req("/api/instance/delete","DELETE",{name:e})}function cloneInstance(){const e=prompt("Enter name of clone of current:");if(null===e)return null;req("/api/instance/clone","POST",{name:e})}function waitForInstanceUpdate(){document.getElementById("instance-management").style.opacity=.5,waiting=!0}function instanceUpdate(e){if(waiting)return void alert("Waiting for previous write to finish ...");const t=e();return null!==t?(waitForInstanceUpdate(),t):void 0}function configUpdate(e){req("/api/config/update","POST",e)}function fullDateFmt(e,t=!1){var n=`${e.getFullYear()}-${(e.getMonth()+1).toString().padStart(2,"0")}-${e.getDate().toString().padStart(2,"0")} ${e.toLocaleTimeString("en-US",{hour12:!1})}`;return t&&(n+="."+e.getMilliseconds().toString().padStart(3,"0")),n}function pushLog(e){const t=document.createElement("p");t.innerText=`[${fullDateFmt(new Date,millis=!0)}] ${e}`;document.getElementById("logs").prepend(t)}function uasniff(e){const t=e.toLowerCase(),n={os:null,deviceType:null,browser:null,mobile:!1};return/iphone|ipod|ipad/.test(t)?n.os="iOS":/windows/.test(t)?n.os="Windows":/macintosh|mac os x/.test(t)?n.os="MacOS":/android/.test(t)?n.os="Android":/linux/.test(t)&&(n.os="Linux"),/mobile|android|iphone|ipad|ipod/.test(t)?(n.mobile=!0,/ipad/.test(t)?n.deviceType="Tablet":n.deviceType="Mobile"):n.deviceType="Desktop",/chrome\/([0-9]+)/.test(t)?n.browser="Chrome":/firefox\/([0-9]+)/.test(t)?n.browser="Firefox":/safari\/([0-9]+)/.test(t)?n.browser="Safari":/edge\/([0-9]+)/.test(t)&&(n.browser="Edge"),n}function updateAccessData(e){const t=document.getElementById("access-data-body");t.innerHTML="";for(const n in e){const o=document.createElement("tr"),a=document.createElement("td");a.innerText=n,o.appendChild(a);const c=document.createElement("td");c.innerText=fullDateFmt(new Date(e[n])),o.appendChild(c);const r=document.createElement("td"),i=document.createElement("button");i.innerText="Modify",i.onclick=()=>{const t=prompt("Enter new expiry date (YYYY-MM-DD hh:mm:ss):",fullDateFmt(new Date(e[n])));if(null===t)return;const o=Date.parse(t);req("/api/token/modify","POST",{token:n,expireIn:o})},r.appendChild(i);const s=document.createElement("button");s.innerText="Delete",s.onclick=()=>{confirm(`Confirm delete token "${n}" ?`)&&req("/api/token/delete","POST",{token:n})},r.appendChild(s),o.appendChild(r),t.appendChild(o)}document.getElementById("access-data").style.display="block"}async function loadAccessData(){const e=await req("/api/token","GET");if(!e.ok)return;updateAccessData(await e.json()),document.getElementById("load-access-data-btn").innerText="Refresh"}function updateClientData(e){const t=document.getElementById("clients-data");t.innerHTML="";for(const n of e){const e=document.createElement("tr"),o=document.createElement("td");o.innerText=fullDateFmt(new Date(n.connectTimestamp)),e.appendChild(o);const a=document.createElement("td"),c=uasniff(n.userAgent);a.innerText=`${c.os}, ${c.browser}`,e.appendChild(a);const r=document.createElement("td");void 0===n.role?r.innerText="Unknown":r.innerText=n.role,e.appendChild(r);const i=document.createElement("td"),s=n.auth;console.log(s),"admin"==s.type?i.innerText="Admin":"token"==s.type?i.innerText=`Token; Until ${fullDateFmt(new Date(parseInt(s.expireIn)))}`:"elevated"==s.type?(i.innerText=`Elevated at ${fullDateFmt(new Date(s.timestamp))}`,console.log(i)):"none"==s.type?i.innerText="None":i.innerText="Malformed",console.log(i),e.appendChild(i);const d=document.createElement("td"),l=document.createElement("button");l.innerText="Disconnect",l.onclick=()=>{websocket.send(`ADMIN:clients-disconnect:${n.id}`)},d.appendChild(l);const u=document.createElement("button");u.innerText="Allow input",u.onclick=()=>{websocket.send(`ADMIN:clients-allow-input:${n.id}`)},d.appendChild(u),e.appendChild(d);const p=document.createElement("td");p.innerText=n.id,e.appendChild(p),t.appendChild(e)}}function createToken(){const e=prompt("Enter access token (at least 4 chars):");if(null===e)return;const t=new Date;t.setHours(23,59,59);const n=prompt("Enter expiry date (YYYY-MM-DD hh:mm:ss):",fullDateFmt(t));if(null===n)return;req("/api/token/create","POST",{token:e,expireIn:Date.parse(n)})}function updateTheme(e){websocket.send(`@theme:${e}`)}const _=(e,t=0)=>{let n=3735928559^t,o=1103547991^t;for(let t,a=0;a<e.length;a++)t=e.charCodeAt(a),n=Math.imul(n^t,2654435761),o=Math.imul(o^t,1597334677);return n=Math.imul(n^n>>>16,2246822507),n^=Math.imul(o^o>>>13,3266489909),o=Math.imul(o^o>>>16,2246822507),o^=Math.imul(n^n>>>13,3266489909),4294967296*(2097151&o)+(n>>>0)},__=e=>_(e,_(e)),websocket=(()=>{const e="https:"===window.location.protocol?"wss:":"ws:",t=window.location.host;return new WebSocket(`${e}//${t}/ws`)})();websocket._send=websocket.send,websocket.send=e=>{if(websocket.readyState==websocket.CONNECTING)report("Websocket connecting",0);else if(websocket.readyState==websocket.CLOSING)report("Websocket connection closing",0);else if(websocket.readyState==websocket.CLOSED)return void report("Websocket disconnected",0);websocket._send(e)};var info={connectionStatus:"not connected"},serverConfig={inputAccess:"unknown",outputAccess:"unknown",backupUrl:"unknown",parentUrl:"unknown"},lastPing=null,waiting=!1;websocket.onopen=e=>{console.log("CONNECTED"),pushLog("[socket] connected"),info.connectionStatus="connected (not admin)",updateInfo(),document.getElementById("button-verify").disabled=!1},websocket.onclose=e=>{console.log("DISCONNECTED"),pushLog("[socket] disconnected"),reset()},websocket.onmessage=e=>{if(console.log(`RECEIVED: ${e.data}`),pushLog(`[socket] received: ${e.data}`),e.data.startsWith("ADMIN:")){if("ADMIN:OVERRIDDEN"==e.data)return websocket.close(),void(document.getElementById("msg").innerText="Session overriden - another client has connected as admin, reload to reconnect");if(e.data.startsWith("ADMIN:INSTANCES:")){const t=JSON.parse(e.data.slice(16)),n=document.getElementById("instances");for(;n.children.length;)n.removeChild(n.children[0]);for(const e of t.instances){const o=document.createElement("button");o.innerText=e,o.value=e,o.onclick=t=>instanceUpdate(()=>{req("/api/instance/switch","POST",{name:e})}),n.appendChild(o),e==t.current&&o.classList.add("selected")}}else if(e.data.startsWith("ADMIN:CLIENTS:")){updateClientData(JSON.parse(e.data.slice(14)))}else e.data.startsWith("ADMIN:SERVERCONFIG:")&&(info.connectionStatus="connected as admin",serverConfig=JSON.parse(e.data.slice(19)),updateInfo())}else if("pong"==e.data)report(`Server responded in ${parseTime(Date.now()-lastPing)}`,1),lastPing=null;else if(e.data.startsWith("@meta:")){const t=JSON.parse(e.data.slice(6)).theme;document.getElementById("theme").value=t}};const reset=()=>{info.connectionStatus="disconnected",info.serverStatus="unknown",updateInfo(),document.getElementById("button-verify").disabled=!0};document.addEventListener("DOMContentLoaded",()=>{reset(),info.connectionStatus="connecting ...",updateInfo()});