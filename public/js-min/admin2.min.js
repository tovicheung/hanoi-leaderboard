function setConnectionStatus(t){document.getElementById("connection-status").innerHTML=t}function checkAdmin(){websocket.send(`ADMIN:${__(document.getElementById("password").value)}`)}function createNewInstance(){const t=prompt("Enter name for new instance:");if(null===t)return null;req("/api/instance/create","POST",{name:t})}function updateInstances(t){const e=document.getElementById("instance-list");e.innerHTML="";for(const n of t.instances){const o=document.createElement("li");o.classList.add("instance-item"),n==t.current&&o.classList.add("active"),o.innerHTML=`\n            <div class="instance-top">\n                <div class="instance-info">\n                    <span class="instance-name"></span>\n                    ${n===t.current?'<span class="active-status">ACTIVE</span>':""}\n                </div>\n                <div class="instance-controls">\n                    <button ${n===t.current?"disabled":""}>Select</button>\n                    <button><span class="material-symbols-outlined">content_copy</span></button>\n                    <button ${n===t.current?"disabled":""}><span class="material-symbols-outlined">delete</span></button>\n                </div>\n            </div>\n            <div class="instance-bottom"></div>\n        `,o.querySelector(".instance-name").innerText=n,o.querySelector(".instance-top").onclick=()=>{if(o.classList.toggle("expanded"),!o.classList.contains("expanded"))return;const t=o.querySelector(".instance-bottom");t.innerHTML="<p>Loading ...</p>",req(`/api/data?name=${n}`,"GET").then(e=>{e.json().then(e=>{t.innerHTML='\n                            <div class="instance-data-col"></div>\n                            <div class="instance-data-col"></div>\n                        ',t.querySelectorAll(".instance-data-col").forEach((t,n)=>{const o=e[n];for(let e=0;e<o.length;e++){const n=document.createElement("div");n.classList.add("instance-data-row"),n.innerHTML=`\n                                    <div class="instance-data-rank">${e+1}</div>\n                                    <div class="instance-data-name">${o[e].name}</div>\n                                    <div class="instance-data-score">${o[e].score}</div>\n                                `,t.appendChild(n)}})})})},o.querySelector("button:nth-child(1)").onclick=t=>{t.stopPropagation(),req("/api/instance/switch","POST",{name:n})},o.querySelector("button:nth-child(2)").onclick=t=>{t.stopPropagation();const e=prompt("Enter new name:");null!==e&&req("/api/instance/clone","POST",{from:n,to:e})},o.querySelector("button:nth-child(3)").onclick=t=>{t.stopPropagation();prompt("Type the instance name again to confirm deletion:")===n&&req("/api/instance/delete","DELETE",{name:n})},e.appendChild(o)}const n=document.getElementById("tab-instances");n.classList.contains("active")||(n.style.visibility="hidden",n.style.display="block",setTimeout(()=>{n.style.display="",n.style.visibility=""},10))}function uasniff(t){const e=t.toLowerCase(),n={os:null,deviceType:null,browser:null,mobile:!1};return/iphone|ipod|ipad/.test(e)?n.os="iOS":/windows/.test(e)?n.os="Windows":/macintosh|mac os x/.test(e)?n.os="MacOS":/android/.test(e)?n.os="Android":/linux/.test(e)&&(n.os="Linux"),/mobile|android|iphone|ipad|ipod/.test(e)?(n.mobile=!0,/ipad/.test(e)?n.deviceType="Tablet":n.deviceType="Mobile"):n.deviceType="Desktop",/chrome\/([0-9]+)/.test(e)?n.browser="Chrome":/firefox\/([0-9]+)/.test(e)?n.browser="Firefox":/safari\/([0-9]+)/.test(e)?n.browser="Safari":/edge\/([0-9]+)/.test(e)&&(n.browser="Edge"),n}function fullDateFmt(t,e=!1){var n=`${t.getFullYear()}-${(t.getMonth()+1).toString().padStart(2,"0")}-${t.getDate().toString().padStart(2,"0")} ${t.toLocaleTimeString("en-US",{hour12:!1})}`;return e&&(n+="."+t.getMilliseconds().toString().padStart(3,"0")),n}function updateClientData(t){const e=document.getElementById("clients-data");e.innerHTML="";for(const n of t){const t=document.createElement("tr"),o=uasniff(n.userAgent),a=n.auth;let s;s="admin"==a.type?"Admin":"token"==a.type?`Token; Until ${fullDateFmt(new Date(parseInt(a.expireIn)))}`:"elevated"==a.type?`Elevated at ${fullDateFmt(new Date(a.timestamp))}`:"none"==a.type?"None":"Malformed",t.innerHTML=`\n            <td>${fullDateFmt(new Date(n.connectTimestamp))}</td>\n            <td>${o.os}, ${o.browser}</td>\n            <td>${void 0===n.role?"Unknown":n.role}</td>\n            <td>${s}</td>\n            <td>\n                <button>Disconnect</button>\n                <button>Allow input</button>\n            </td>\n        `;document.createElement("td");t.querySelector("button:nth-child(1)").onclick=()=>{websocket.send(`ADMIN:clients-disconnect:${n.id}`)},t.querySelector("button:nth-child(2)").onclick=()=>{websocket.send(`ADMIN:clients-allow-input:${n.id}`)},e.appendChild(t)}}function showNotification(t,e,n={}){let o=null==e?"white":e?"lightgreen":"pink";const a=document.createElement("div");a.className="notification",a.innerHTML=`\n        <span>${t}</span>\n        <button class="close-btn" title="Dismiss">&times;</button>\n    `,a.style.backgroundColor=o,a.querySelector(".close-btn").onclick=()=>a.remove(),document.getElementById("notifications").appendChild(a);const s=n.duration??2e3;s>0&&setTimeout(()=>a.remove(),s)}function showTab(t){document.querySelectorAll("#tab-content > div").forEach(t=>t.classList.remove("active")),document.getElementById(`tab-${t}`).classList.add("active"),document.querySelectorAll(".tab-btn").forEach(e=>{e.classList.toggle("active",e.getAttribute("data-tab")===t)})}async function req(t,e,n){t.startsWith("/")&&(t=t.slice(1));const o=await fetch(`${window.location.protocol}//${window.location.host}/${t}`,{method:e,headers:{"Content-Type":"application/json",Authorization:`Bearer ${__(document.getElementById("password").value)}`},body:"GET"==e?void 0:JSON.stringify(n)});return o.ok?"GET"!=e&&showNotification("Success",1):showNotification(`[${o.status}] ${await o.text()}`,0),o}function configUpdate(t){req("/api/config/update","POST",t)}async function createToken(){const t=prompt("Enter access token (at least 4 chars):");if(null===t)return;const e=new Date;e.setHours(23,59,59);const n=prompt("Enter expiry date (YYYY-MM-DD hh:mm:ss):",fullDateFmt(e));if(null===n)return;const o=Date.parse(n);await req("/api/token/create","POST",{token:t,expireIn:o}),loadAccessData()}function updateAccessData(){const t=document.getElementById("access-data-body");t.innerHTML="";const e=document.getElementById("vis").checked;for(const n in _tokdata){const o=document.createElement("tr");o.innerHTML=`\n            <td>${e?n:"****"}</td>\n            <td>${fullDateFmt(new Date(_tokdata[n]))}</td>\n            <td>\n                <button>Modify</button>\n                <button>Delete</button>\n            </td>\n        `,o.querySelector("button:nth-child(1)").onclick=async()=>{const t=prompt("Enter new expiry date (YYYY-MM-DD hh:mm:ss):",fullDateFmt(new Date(_tokdata[n])));if(null===t)return;const e=Date.parse(t);await req("/api/token/modify","POST",{token:n,expireIn:e}),loadAccessData()},o.querySelector("button:nth-child(2)").onclick=async()=>{prompt("Type the token again to confirm deletion:")===n&&(await req("/api/token/delete","POST",{token:n}),loadAccessData())},t.appendChild(o)}}async function loadAccessData(){const t=await req("/api/token","GET");t.ok&&(_tokdata=await t.json(),updateAccessData())}function modifyBackupUrl(){let t=prompt("Enter new backup url:",serverConfig.backupUrl);null!=t&&(""==t&&(t=null),configUpdate({backupUrl:t}))}function modifyParentUrl(){let t=prompt("Enter new parent url:",serverConfig.parentUrl);null!=t&&(""==t&&(t=null),configUpdate({parentUrl:t}))}function setupSegmentButtons(t,e){document.getElementById(t).querySelectorAll("button").forEach(t=>{t.onclick=()=>e(t.getAttribute("value"))})}function setSegmentButtons(t,e){document.getElementById(t).querySelectorAll("button").forEach(t=>{t.classList.toggle("selected",t.getAttribute("value")===e)})}const _=(t,e=0)=>{let n=3735928559^e,o=1103547991^e;for(let e,a=0;a<t.length;a++)e=t.charCodeAt(a),n=Math.imul(n^e,2654435761),o=Math.imul(o^e,1597334677);return n=Math.imul(n^n>>>16,2246822507),n^=Math.imul(o^o>>>13,3266489909),o=Math.imul(o^o>>>16,2246822507),o^=Math.imul(n^n>>>13,3266489909),4294967296*(2097151&o)+(n>>>0)},__=t=>_(t,_(t)),websocket=(()=>{const t="https:"===window.location.protocol?"wss:":"ws:",e=window.location.host;return new WebSocket(`${t}//${e}/ws`)})();websocket._send=websocket.send,websocket.send=t=>{if(websocket.readyState==websocket.CONNECTING)showNotification("Websocket is connecting",0);else if(websocket.readyState==websocket.CLOSING)showNotification("Websocket is closing",0);else if(websocket.readyState==websocket.CLOSED)return void showNotification("Websocket is disconnected",0);websocket._send(t)},websocket.onopen=()=>{setConnectionStatus("Authentication required"),websocket.send("ADMIN:TEST")},websocket.onclose=()=>{setConnectionStatus("<span style='color: red'>Disconnected</span>")},websocket.onmessage=t=>{if(console.log(`RECEIVED: ${t.data}`),"AUTH:failure"===t.data)document.getElementById("auth-msg").innerText="Wrong Password",document.getElementById("auth-msg").style.color="red";else if(t.data.startsWith("ADMIN:"))if("ADMIN:OK"===t.data)setConnectionStatus("Connected"),showTab("clients"),showNotification("Authenticated!",1),document.getElementById("auth-msg").innerText="Authenticated",document.getElementById("auth-msg").style.color="green",loadAccessData(),document.querySelector(".tab-btn.warn").classList.remove("warn");else{if("ADMIN:OVERRIDDEN"==t.data)return document.getElementById("password").value="",websocket.onclose=()=>setConnectionStatus("<span style='color: red'>Overridden</span>"),websocket.close(),void showNotification("This session is overridden by another session. Reload to reconnect.",type=0,{duration:5e3});if(t.data.startsWith("ADMIN:INSTANCES:")){updateInstances(JSON.parse(t.data.slice(16)))}else if(t.data.startsWith("ADMIN:CLIENTS:")){updateClientData(JSON.parse(t.data.slice(14)))}else t.data.startsWith("ADMIN:SERVERCONFIG:")&&(serverConfig=JSON.parse(t.data.slice(19)),setSegmentButtons("inputAccess",serverConfig.inputAccess),null===serverConfig.backupUrl?document.getElementById("backup-url").innerText="[unset]":document.getElementById("backup-url").innerText=serverConfig.backupUrl,document.getElementById("parent-url").innerText=null===serverConfig.parentUrl?"[unset]":serverConfig.parentUrl)}else"pong"==t.data?(report(`Server responded in ${parseTime(Date.now()-lastPing)}`,1),lastPing=null):t.data.startsWith("@meta:")},document.querySelectorAll(".tab-btn").forEach(t=>{t.onclick=()=>{showTab(t.getAttribute("data-tab"))}}),showTab("auth"),document.getElementById("auth-form").onsubmit=t=>{t.preventDefault(),checkAdmin()};let _tokdata={};setupSegmentButtons("inputAccess",t=>{configUpdate({inputAccess:t})});