function setConnectionStatus(t){document.getElementById("connection-status").innerHTML=t}function checkAdmin(){websocket.send(`ADMIN:${__(document.getElementById("password").value)}`)}function createNewInstance(){const t=prompt("Enter name for new instance:");if(null===t)return null;req("/api/instance/create","POST",{name:t})}function updateInstances(t){const e=document.getElementById("instance-list");e.innerHTML="";for(const n of t.instances){const o=document.createElement("li");o.classList.add("instance-item"),n==t.current&&o.classList.add("active"),o.innerHTML=`\n            <div class="instance-top">\n                <div class="instance-info">\n                    <span class="instance-name"></span>\n                    ${n===t.current?'<span class="active-status">ACTIVE</span>':""}\n                </div>\n                <div class="instance-controls">\n                    <button ${n===t.current?"disabled":""}>Select</button>\n                    <button><span class="material-symbols-outlined">content_copy</span></button>\n                    <button ${n===t.current?"disabled":""}><span class="material-symbols-outlined">delete</span></button>\n                </div>\n            </div>\n            <div class="instance-bottom"></div>\n        `,o.querySelector(".instance-name").innerText=n,o.onclick=t=>{req(`/api/data?name=${n}`,"GET").then(t=>{t.json().then(t=>{o.classList.toggle("expanded");const e=o.querySelector(".instance-bottom");e.innerHTML='\n                            <div class="instance-data-col"></div>\n                            <div class="instance-data-col"></div>\n                        ',e.querySelectorAll(".instance-data-col").forEach((e,n)=>{const o=t[n];for(let t=0;t<o.length;t++){const n=document.createElement("div");n.classList.add("instance-data-row"),n.innerHTML=`\n                                    <div class="instance-data-rank">${t+1}</div>\n                                    <div class="instance-data-name">${o[t].name}</div>\n                                    <div class="instance-data-score">${o[t].score}</div>\n                                `,e.appendChild(n)}})})})},o.querySelector("button:nth-child(1)").onclick=t=>{t.stopPropagation(),req("/api/instance/switch","POST",{name:n})},o.querySelector("button:nth-child(2)").onclick=t=>{t.stopPropagation();const e=prompt("Enter new name:");null!==e&&req("/api/instance/clone","POST",{from:n,to:e})},o.querySelector("button:nth-child(3)").onclick=t=>{t.stopPropagation();prompt("Type the instance name again to confirm deletion:")===n&&req("/api/instance/delete","DELETE",{name:n})},e.appendChild(o)}}function uasniff(t){const e=t.toLowerCase(),n={os:null,deviceType:null,browser:null,mobile:!1};return/iphone|ipod|ipad/.test(e)?n.os="iOS":/windows/.test(e)?n.os="Windows":/macintosh|mac os x/.test(e)?n.os="MacOS":/android/.test(e)?n.os="Android":/linux/.test(e)&&(n.os="Linux"),/mobile|android|iphone|ipad|ipod/.test(e)?(n.mobile=!0,/ipad/.test(e)?n.deviceType="Tablet":n.deviceType="Mobile"):n.deviceType="Desktop",/chrome\/([0-9]+)/.test(e)?n.browser="Chrome":/firefox\/([0-9]+)/.test(e)?n.browser="Firefox":/safari\/([0-9]+)/.test(e)?n.browser="Safari":/edge\/([0-9]+)/.test(e)&&(n.browser="Edge"),n}function fullDateFmt(t,e=!1){var n=`${t.getFullYear()}-${(t.getMonth()+1).toString().padStart(2,"0")}-${t.getDate().toString().padStart(2,"0")} ${t.toLocaleTimeString("en-US",{hour12:!1})}`;return e&&(n+="."+t.getMilliseconds().toString().padStart(3,"0")),n}function updateClientData(t){const e=document.getElementById("clients-data");e.innerHTML="";for(const n of t){const t=document.createElement("tr"),o=uasniff(n.userAgent),s=n.auth;let a;a="admin"==s.type?"Admin":"token"==s.type?`Token; Until ${fullDateFmt(new Date(parseInt(s.expireIn)))}`:"elevated"==s.type?`Elevated at ${fullDateFmt(new Date(s.timestamp))}`:"none"==s.type?"None":"Malformed",t.innerHTML=`\n            <td>${fullDateFmt(new Date(n.connectTimestamp))}</td>\n            <td>${o.os}, ${o.browser}</td>\n            <td>${void 0===n.role?"Unknown":n.role}</td>\n            <td>${a}</td>\n            <td>\n                <button>Disconnect</button>\n                <button>Allow input</button>\n            </td>\n        `;document.createElement("td");t.querySelector("button:nth-child(1)").onclick=()=>{websocket.send(`ADMIN:clients-disconnect:${n.id}`)},t.querySelector("button:nth-child(2)").onclick=()=>{websocket.send(`ADMIN:clients-allow-input:${n.id}`)},e.appendChild(t)}}function showNotification(t,e,n={}){let o=null==e?"white":e?"lightgreen":"pink";const s=document.createElement("div");s.className="notification",s.innerHTML=`\n        <span>${t}</span>\n        <button class="close-btn" title="Dismiss">&times;</button>\n    `,s.style.backgroundColor=o,s.querySelector(".close-btn").onclick=()=>s.remove(),document.getElementById("notifications").appendChild(s);const a=n.duration??2e3;a>0&&setTimeout(()=>s.remove(),a)}function showTab(t){document.querySelectorAll("#tab-content > div").forEach(t=>t.classList.remove("active")),document.getElementById(`tab-${t}`).classList.add("active"),document.querySelectorAll(".tab-btn").forEach(e=>{e.classList.toggle("active",e.getAttribute("data-tab")===t)})}async function req(t,e,n){t.startsWith("/")&&(t=t.slice(1));const o=await fetch(`${window.location.protocol}//${window.location.host}/${t}`,{method:e,headers:{"Content-Type":"application/json",Authorization:`Bearer ${__(document.getElementById("password").value)}`},body:"GET"==e?void 0:JSON.stringify(n)});return o.ok?"GET"!=e&&showNotification("Success",1):showNotification(`[${o.status}] ${await o.text()}`,0),o}function configUpdate(t){req("/api/config/update","POST",t)}function setupSegmentButtons(t,e){document.getElementById(t).querySelectorAll("button").forEach(t=>{t.onclick=()=>e(t.getAttribute("value"))})}function setSegmentButtons(t,e){document.getElementById(t).querySelectorAll("button").forEach(t=>{t.classList.toggle("selected",t.getAttribute("value")===e)})}const _=(t,e=0)=>{let n=3735928559^e,o=1103547991^e;for(let e,s=0;s<t.length;s++)e=t.charCodeAt(s),n=Math.imul(n^e,2654435761),o=Math.imul(o^e,1597334677);return n=Math.imul(n^n>>>16,2246822507),n^=Math.imul(o^o>>>13,3266489909),o=Math.imul(o^o>>>16,2246822507),o^=Math.imul(n^n>>>13,3266489909),4294967296*(2097151&o)+(n>>>0)},__=t=>_(t,_(t)),websocket=(()=>{const t="https:"===window.location.protocol?"wss:":"ws:",e=window.location.host;return new WebSocket(`${t}//${e}/ws`)})();websocket._send=websocket.send,websocket.send=t=>{if(websocket.readyState==websocket.CONNECTING)showNotification("Websocket is connecting",0);else if(websocket.readyState==websocket.CLOSING)showNotification("Websocket is closing",0);else if(websocket.readyState==websocket.CLOSED)return void showNotification("Websocket is disconnected",0);websocket._send(t)},websocket.onopen=()=>{setConnectionStatus("Authentication required"),websocket.send("ADMIN:TEST")},websocket.onclose=()=>{setConnectionStatus("<span style='color: red'>Disconnected</span>")},websocket.onmessage=t=>{if(console.log(`RECEIVED: ${t.data}`),"AUTH:failure"===t.data)document.getElementById("auth-msg").innerText="Wrong Password",document.getElementById("auth-msg").style.color="red";else if(t.data.startsWith("ADMIN:"))if("ADMIN:OK"===t.data)setConnectionStatus("Connected"),showTab("clients"),showNotification("Authenticated!",1),document.getElementById("auth-msg").innerText="Authenticated",document.getElementById("auth-msg").style.color="green";else{if("ADMIN:OVERRIDDEN"==t.data)return websocket.onclose=()=>setConnectionStatus("<span style='color: red'>Overridden</span>"),void websocket.close();if(t.data.startsWith("ADMIN:INSTANCES:")){updateInstances(JSON.parse(t.data.slice(16)))}else if(t.data.startsWith("ADMIN:CLIENTS:")){updateClientData(JSON.parse(t.data.slice(14)))}else t.data.startsWith("ADMIN:SERVERCONFIG:")&&(serverConfig=JSON.parse(t.data.slice(19)),setSegmentButtons("inputAccess",serverConfig.inputAccess))}else if("pong"==t.data)report(`Server responded in ${parseTime(Date.now()-lastPing)}`,1),lastPing=null;else if(t.data.startsWith("@meta:")){const e=JSON.parse(t.data.slice(6)).theme;document.getElementById("theme").value=e}},document.querySelectorAll(".tab-btn").forEach(t=>{t.onclick=()=>{showTab(t.getAttribute("data-tab"))}}),showTab("auth"),document.getElementById("auth-form").onsubmit=t=>{t.preventDefault(),checkAdmin()},setupSegmentButtons("inputAccess",t=>{configUpdate({inputAccess:t})});