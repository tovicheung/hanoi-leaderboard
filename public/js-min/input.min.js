function parseTime(e){const t=new Date(e);return`${t.getMinutes().toString().padStart(2,"0")}:${t.getSeconds().toString().padStart(2,"0")}.${t.getMilliseconds().toString().padStart(3,"0")}`}function updateLeaderboards(){updateLeaderboard("leaderboard1",leaderboard1),updateLeaderboard("leaderboard2",leaderboard2),updateTimeLimits()}function setStatus(e,t=!1){const n=document.getElementById("status");n.style.display="block",n.innerText=e,t&&setTimeout(()=>n.style.display="none",1500)}function switchScreen(e){for(const e of document.getElementById("container").children)e.style.display="none";document.getElementById(`screen${e}`).style.display="block",4==e?(websocket.send(`!reginit-${trialOptions.ndisks}${trialOptions.name}`),document.querySelectorAll(".trial-name").forEach(e=>e.innerText=trialOptions.name),document.querySelectorAll(".trial-ndisks").forEach(e=>e.innerText=trialOptions.ndisks),checkName(trialOptions.name)||(switchScreen(6),document.getElementById("custom-name-input").value=trialOptions.name)):6==e?(document.getElementById("custom-name-input").value="",document.getElementById("custom-name-input").focus()):997==e&&connectionTest()}function connectionTest2(){const e=document.getElementById("connection-test-display"),t=document.getElementById("connection-test-actions");e.innerText="Socket failed\nTesting HTTP connection ...",fetch("/ping").then(n=>{n.ok?(e.innerHTML="<span style='color: brown'>HTTP ok; socket closed</span>",t.innerHTML="Reload this page to reconnect.",document.getElementById("test-again").style.display=""):(e.innerHTML=`<span style='color: red'>Server returned an error<br>${n.status} ${n.statusText}</span>`,t.innerHTML="* Do NOT reload anything.<br>* Test the connection again and again using the button below. (the server *should* restart soon)<br>* When the connection is finally resumed, reload everything.",document.getElementById("test-again").style.display="")}).catch(n=>{e.innerHTML="<span style='color: red'>The server is unreachable",t.innerHTML="Check the internet connection on this device.<br>If it is not a problem with internet connection:<br>* Do NOT reload anything.<br>* Test the connection again and again using the button below. (the server *should* restart soon)<br>* When the connection is finally resumed, reload everything.",document.getElementById("test-again").style.display=""})}function connectionTest(){document.getElementById("test-again").style.display="none";const e=document.getElementById("connection-test-display"),t=document.getElementById("connection-test-actions");e.innerHTML="Testing socket connection ...",t.innerText="Please wait";const n=websocket.onmessage,o=setTimeout(()=>{websocket.onmessage=n,connectionTest2()},2e3);websocket.onmessage=i=>"pong"===i.data?(websocket.onmessage=n,clearTimeout(o),e.innerHTML="<span style='color: darkgreen'>No problems detected.</span>",void(t.innerText="If the output computer is disconnected and fails to auto-reconnect, press Ctrl+Shift+R on the computer to fully reload.")):n(i),websocket.send("ping")}function sendUpdate(){websocket.send(JSON.stringify({type:"update",leaderboards:[leaderboard1,leaderboard2]}))}function pushRecord(e,t,n){e.forEach((o,i)=>{o.name==t&&(o.score<n&&(n=o.score),e.splice(i,1))}),e.push({name:t,score:n})}function adjustHeight(){const e=prompt("Enter number of rows to show below the top 3 (default 7):");null!==e&&websocket.send(`!adjust-height-${e}`)}function announce(){const e=prompt("Enter announcement:\n(Leave blank to remove announcement)").trim();null!==e&&(0!=e.length?websocket.send(`!announcement-show:${e}`):websocket.send("!announcement-hide"))}function checkName(e){let t=[];for(const n of leaderboard1)if(n.name===e){t.push({disks:4,record:n});break}if(0==t.length)for(const n of leaderboard2)if(n.name===e){t.push({disks:5,record:n});break}if(0==t.length)return!0;msg=`The name '${e}' already exists:\n\n`;for(const e of t)msg+=`${e.disks} disks  -  ${e.record.name}  -  ${parseTime(e.record.score)}\n`;return msg+="\nClick OK if this is intentional; else, click cancel to cancel the operation.",window.confirm(msg)}function addRaw(){const e=prompt("Insert record (Step 1/3)\n4 or 5 disks?");if("4"!==e&&"5"!==e)return;const t=prompt("Insert record (Step 2/3)\nEnter the name:");if(null===t)return;if(!checkName(t))return;let n=prompt("Insert record (Step 3/3)\nEnter the time:\nLeave blank to enter the number of milliseconds directly");if(null!==n){if(""===n){if(n=prompt("Insert record (Step 3/3)\nEnter the number of milliseconds:"),null===n)return;n=parseInt(n)}else n=timeStringToMillis(n);pushRecord("4"==e?leaderboard1:leaderboard2,t,n),sendUpdate()}}function sendNewRecord(){websocket.send("!regconfirm"),pushRecord(4==trialOptions.ndisks?leaderboard1:leaderboard2,trialOptions.name,score),sendUpdate(),switchScreen(1)}function timerClickListener(e){clearInterval(trialOptions.timerInterval),clearInterval(trialOptions.timeoutInterval),score=Date.now()-trialOptions.startTime,"forceTime"in e&&null!==e.forceTime&&(score=e.forceTime),removeEventListener("mousedown",timerClickListener),removeEventListener("touchstart",timerClickListener),document.getElementById("timer-start-button").style.display="block",document.getElementById("timer-cancel-button").style.display="block",websocket.send(`!regend-${score}`),switchScreen(5),document.querySelectorAll(".trial-result").forEach(e=>e.innerText=parseTime(score)),document.getElementById("timer").innerText="00:00.000"}function startTimer(){trialOptions.timeLimit=timeLimits[4==trialOptions.ndisks?"leaderboard1":"leaderboard2"],trialOptions.startTime=Date.now(),trialOptions.timerInterval=setInterval(()=>{document.getElementById("timer").innerText=parseTime(Date.now()-trialOptions.startTime)},57),-1!=trialOptions.timeLimit&&(trialOptions.timeoutInterval=setInterval(()=>{timerClickListener({forceTime:trialOptions.timeLimit})},trialOptions.timeLimit)),addEventListener("mousedown",timerClickListener),addEventListener("touchstart",timerClickListener),document.getElementById("timer-start-button").style.display="none",document.getElementById("timer-cancel-button").style.display="none",websocket.send("!regstart")}function timeStringToMillis(e){let t=e.split(":");const n=parseInt(t[0]);t=t[1].split(".");return 1e3*(60*n+parseInt(t[0]))+parseInt(t[1])}function timeLimitDisplay(e){return-1==e?"none":millisToCoarseTime(e)}function updateTimeLimits(){for(const e in timeLimits){const t=timeLimits[e],n=document.getElementById(`time-limit-${e}`);n.innerText=-1===t?"none":millisToCoarseTime(t)}}function modifyRank(e,t){const n=prompt("Modify Record (Step 1/2)\nEdit the name:",e[t-1].name);if(null===n)return;if(n!=e[t-1].name&&!checkName(n))return;const o=prompt("Modify Record (Step 2/2)\nEdit the time:\nLeave blank to edit the number of milliseconds directly",parseTime(e[t-1].score));if(null===o)return;let i;if(""==o){if(i=prompt("Modify Record (Step 2/2)\nEdit the number of milliseconds:",e[t-1].score),null===i)return;i=parseInt(i)}else i=timeStringToMillis(o);e[t-1]={name:n,score:i},sendUpdate()}function removeRank(e,t){e.splice(t-1,1),sendUpdate()}function updateLeaderboard(e,t){const n=document.getElementById(e);n.innerHTML=`<h2 class="header">${id2titles[e]}</h2>`,n.innerHTML+=`<div class="header2">Time limit = <span id="time-limit-${e}"></span><span class="action" onclick="editTimeLimit('${e}')">[Edit]</span></div>`;var o=1;for(const{name:e,score:i}of t){const s=document.createElement("div");s.classList.add("record");const r=document.createElement("span");r.classList.add("record-rank"),r.innerText=o.toString();const c=document.createElement("span");c.classList.add("record-name"),c.innerText=e;const a=document.createElement("span");a.classList.add("record-time"),a.innerText=parseTime(i),s.appendChild(r),s.appendChild(c),s.appendChild(a);const l=document.createElement("span");l.classList.add("action"),l.innerText="[Mod]",l._rank=o,l.style.marginLeft="12px",l.onclick=e=>modifyRank(t,e.target._rank);const d=document.createElement("span");d.classList.add("action"),d.innerText="[Del]",d._rank=o,d.onclick=n=>{window.confirm(`Remove this record?\n${e}  -  ${i}`)&&removeRank(t,n.target._rank)},s.appendChild(l),s.appendChild(d),n.appendChild(s),o++}0==t.length&&(n.innerHTML="<h2>empty</h2>"),n.style.backgroundColor="lightgreen",setTimeout(()=>n.style.backgroundColor="",300)}function coarseTimeToMillis(e){if(/^\d+$/.test(e))return parseInt(e,10);const t=e.match(/^(?:(\d+)m)?(?:(\d+)s)?$/);if(!t||void 0===t[1]&&void 0===t[2])return 0;let n=0;const o=t[1];void 0!==o&&(n+=60*parseInt(o,10)*1e3);const i=t[2];return void 0!==i&&(n+=1e3*parseInt(i,10)),n}function millisToCoarseTime(e){const t=(e=1e3*Math.floor(e/1e3))/1e3,n=Math.floor(t/60),o=t%60;let i="";return n>0&&(i+=`${n}m`),o>0?i+=`${o}s`:0===n&&0===o&&(i="0s"),i}function newTrial(e){trialOptions.ndisks=e,switchScreen(6)}function useAccessToken(){const e=prompt("Enter access token:");null!==e&&(e.length<4||(websocket.send("AUTH:token:"+e),localStorage.setItem("token",e)))}function customName(){const e=prompt("Enter name:");null!==e&&(trialOptions.name=e,switchScreen(4))}function editTimeLimit(e){const t=prompt("Enter new time limit\nExamples: '4m' / '2m30s' / '1000' (1000 millis)\nEnter '-1' to remove time limit",timeLimits[e]);if(null!==t&&0!=t.length)if("-1"==t)websocket.send(`@timeLimit:${e}:-1`);else{let n=coarseTimeToMillis(t);n=isNaN(n)?-1:n,websocket.send(`@timeLimit:${e}:${n}`)}}let timeLimit=-1,timeLimits={leaderboard1:-1,leaderboard2:-1},theme="gojo",leaderboard1=[],leaderboard2=[];const id2titles={leaderboard1:"4 disks",leaderboard2:"5 disks"},trialOptions={name:"",ndisks:4,startTime:0,timerInterval:0,timeoutInterval:0,score:0,timeLimit:-1},websocket=(()=>{const e="https:"===window.location.protocol?"wss:":"ws:",t=window.location.host;return new WebSocket(`${e}//${t}/ws`)})();websocket.onopen=e=>{console.log("CONNECTED"),websocket.send("REPORT-ROLE:Input")},websocket.onclose=e=>{console.log("DISCONNECTED"),setStatus("Disconnected. Reload to reconnect."),document.getElementById("reload-this-button").style.color="blue"},websocket.onmessage=e=>{if(console.log(`RECEIVED: ${e.data}`),e.data.startsWith("@")){if(e.data.startsWith("@nclients:"))document.getElementById("nclients").innerText=e.data.slice(10);else if(e.data.startsWith("@meta:")){const t=JSON.parse(e.data.slice(6));timeLimits=t.timeLimits,theme=t.theme,updateTimeLimits()}return}if(e.data.startsWith("!"))return void("!reload-all"==e.data&&window.location.reload());if(e.data.startsWith("AUTH:")){if("AUTH:required"==e.data){const e=localStorage.getItem("token");null==e?(switchScreen(999),setStatus("Server blocked input requests.")):(websocket.send(`AUTH:token:${e}`),setStatus("Authenticating ..."))}else"AUTH:success"==e.data?(setStatus("Permission granted.",!0),switchScreen(1)):"AUTH:failure"==e.data&&(localStorage.removeItem("token"),switchScreen(999),setStatus("Server blocked input requests."));return}const t=JSON.parse(e.data);leaderboard1=t[0],leaderboard2=t[1],updateLeaderboards()},websocket.onerror=e=>{console.log(`ERROR: ${e.data}`)},document.addEventListener("DOMContentLoaded",()=>{document.getElementById("new-trial-4").onclick=()=>newTrial(4),document.getElementById("new-trial-5").onclick=()=>newTrial(5),document.getElementById("refresh-all-button").onclick=()=>{websocket.send("refresh-all")},document.getElementById("reload-all-button").onclick=()=>{websocket.send("!reload-all")},document.getElementById("disconnect-all-button").onclick=()=>{websocket.send("!disconnect-all-output")},document.getElementById("manual-input-button").onclick=()=>{addRaw()},document.getElementById("reset-l4-button").onclick=()=>{leaderboard1=[],sendUpdate()},document.getElementById("reset-l5-button").onclick=()=>{leaderboard2=[],sendUpdate()},document.getElementById("toggle-l4-button").onclick=()=>{websocket.send("!toggle-l4")},document.getElementById("toggle-l5-button").onclick=()=>{websocket.send("!toggle-l5")},document.getElementById("adjust-height-button").onclick=()=>{adjustHeight()},document.getElementById("clear-animation-button").onclick=()=>{websocket.send("!regcancel")},document.getElementById("announce-button").onclick=()=>{announce()},document.getElementById("custom-name-button").onclick=customName,document.getElementById("timer-start-button").onclick=startTimer,document.getElementById("result-confirm-button").onclick=sendNewRecord,document.getElementById("result-cancel-button").onclick=()=>{websocket.send("!regcancel"),switchScreen(1)},document.getElementById("action-use-access-token").onclick=useAccessToken,document.querySelectorAll(".screen-1-button").forEach(e=>e.onclick=()=>{switchScreen(1)}),document.getElementById("name-confirm-button").onclick=()=>{trialOptions.name=document.getElementById("custom-name-input").value,""!=trialOptions.name?switchScreen(4):alert("Name cannot be empty!")},document.querySelectorAll("button[dangerous]").forEach(e=>{e._onclick=e.onclick,e.onclick=()=>{"yes!"==prompt("Are you sure? Type 'yes!' to confirm.")&&e._onclick()}}),switchScreen(1)});