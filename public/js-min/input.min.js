function parseTime(e){const t=new Date(e);return`${t.getMinutes().toString().padStart(2,"0")}:${t.getSeconds().toString().padStart(2,"0")}.${t.getMilliseconds().toString().padStart(3,"0")}`}function updateLeaderboards(){for(const e in leaderboards)updateLeaderboard(e,leaderboards[e]);updateTimeLimits()}function setStatus(e,t=!1){null!==statusTimeout&&clearTimeout(statusTimeout);const n=document.getElementById("status");n.style.display="block",n.innerText=e,t&&(statusTimeout=setTimeout(()=>n.style.display="none",1500))}function switchScreen(e){for(const e of document.getElementById("container").children)e.style.display="none";document.getElementById(`screen${e}`).style.display="block",4==e?(checkName(trialOptions.name)||(switchScreen(6),document.getElementById("custom-name-input").value=trialOptions.name),websocket.send(`!reginit-${trialOptions.ndisks}${trialOptions.name}`),document.querySelectorAll(".trial-name").forEach(e=>e.innerText=trialOptions.name),document.querySelectorAll(".trial-ndisks").forEach(e=>e.innerText=trialOptions.ndisks)):6==e&&(document.getElementById("custom-name-input").value="",document.getElementById("custom-name-input").focus())}function connectionTest2(){const e=document.getElementById("connection-test-display"),t=document.getElementById("connection-test-actions");e.innerText="Socket failed\nTesting HTTP connection ...",fetch("/ping").then(n=>{n.ok?(e.innerHTML="<span style='color: brown'>HTTP ok; socket closed</span>",t.innerHTML="Reload this page to reconnect."):(e.innerHTML=`<span style='color: red'>Server returned an error<br>${n.status} ${n.statusText}</span>`,t.innerHTML="* Do NOT reload anything.<br>* Test the connection again and again. (the server *should* restart soon)<br>* When the connection is finally resumed, reload everything.")}).catch(n=>{e.innerHTML="<span style='color: red'>The server is unreachable",t.innerHTML="Check the internet connection on this device.<br>If it is not a problem with internet connection:<br>* Do NOT reload anything.<br>* Test the connection again and again. (the server *should* restart soon)<br>* When the connection is finally resumed, reload everything."})}function connectionTest(){document.getElementById("connection-test").style.display="block";const e=document.getElementById("connection-test-display"),t=document.getElementById("connection-test-actions");e.innerHTML="Testing socket connection ...",t.innerText="Please wait";const n=websocket.onmessage,o=setTimeout(()=>{websocket.onmessage=n,connectionTest2()},2e3);websocket.onmessage=i=>"pong"===i.data?(websocket.onmessage=n,clearTimeout(o),e.innerHTML="<span style='color: darkgreen'>No problems detected.</span>",void(t.innerText="If the output computer is disconnected and fails to auto-reconnect, press Ctrl+Shift+R on the computer to fully reload.")):n(i),websocket.send("ping")}function sendUpdate(e=null){websocket.send(`UPDATE:${JSON.stringify({leaderboards:leaderboards,highlight:e})}`)}function pushRecord(e,t,n,o=!1){const i=leaderboards[`lb${parseInt(e)}`];i.forEach((e,o)=>{e.name==t&&(e.score<n&&(n=e.score),i.splice(o,1))}),i.push({name:t,score:n}),i.sort((e,t)=>e.score-t.score),o?sendUpdate({id:`lb${e}`,name:t}):sendUpdate()}function adjustHeight(){const e=prompt("Enter number of rows to show below the top 3 (default 7):");null!==e&&websocket.send(`!adjust-height-${e}`)}function announce(){const e=prompt("Enter announcement:\n(Leave blank to remove announcement)").trim();null!==e&&(0!=e.length?websocket.send(`!announcement-show:${e}`):websocket.send("!announcement-hide"))}function checkName(e){let t=[];for(const n of leaderboards.lb4)if(n.name===e){t.push({disks:4,record:n});break}for(const n of leaderboards.lb5)if(n.name===e){t.push({disks:5,record:n});break}if(0==t.length)return!0;msg=`The name '${e}' already exists:\n\n`;for(const e of t)msg+=`[${e.disks} DISKS]  ${e.record.name}  -  ${parseTime(e.record.score)}\n`;return msg+="\nClick OK if this is intentional.\nClick cancel to cancel the operation.",window.confirm(msg)}function addRaw(){const e=prompt("Insert record (Step 1/3)\n4 or 5 disks?");if("4"!==e&&"5"!==e)return;const t=prompt("Insert record (Step 2/3)\nEnter the name:");if(null===t)return;if(!checkName(t))return;let n=prompt("Insert record (Step 3/3)\nEnter the time:\nLeave blank to enter the number of milliseconds directly");if(null!==n){if(""===n){if(n=prompt("Insert record (Step 3/3)\nEnter the number of milliseconds:"),null===n)return;n=parseInt(n)}else n=timeStringToMillis(n);pushRecord(e,t,n)}}function sendNewRecord(){websocket.send("!regconfirm"),pushRecord(trialOptions.ndisks,trialOptions.name,score,!0),switchScreen(1)}function timerClickListener(e){clearInterval(trialOptions.timerInterval),clearInterval(trialOptions.timeoutInterval),score=Date.now()-trialOptions.startTime,"forceTime"in e&&null!==e.forceTime&&(score=e.forceTime),removeEventListener("mousedown",timerClickListener),removeEventListener("touchstart",timerClickListener),document.getElementById("timer-start-button").style.display="block",document.getElementById("timer-cancel-button").style.display="block",websocket.send(`!regend-${score}`),switchScreen(5),document.querySelectorAll(".trial-result").forEach(e=>e.innerText=parseTime(score)),document.getElementById("timer").innerText="00:00.000"}function startTimer(){trialOptions.timeLimit=timeLimits[`lb${trialOptions.ndisks}`],trialOptions.startTime=Date.now(),trialOptions.timerInterval=setInterval(()=>{document.getElementById("timer").innerText=parseTime(Date.now()-trialOptions.startTime)},57),-1!=trialOptions.timeLimit&&(trialOptions.timeoutInterval=setInterval(()=>{timerClickListener({forceTime:trialOptions.timeLimit})},trialOptions.timeLimit)),addEventListener("mousedown",timerClickListener),addEventListener("touchstart",timerClickListener),document.getElementById("timer-start-button").style.display="none",document.getElementById("timer-cancel-button").style.display="none",websocket.send("!regstart")}function timeStringToMillis(e){let t=e.split(":");const n=parseInt(t[0]);t=t[1].split(".");return 1e3*(60*n+parseInt(t[0]))+parseInt(t[1])}function timeLimitDisplay(e){return-1==e?"none":millisToCoarseTime(e)}function updateTimeLimits(){for(const e in timeLimits){const t=timeLimits[e],n=document.getElementById(`time-limit-${e}`);n&&(n.innerText=-1===t?"none":millisToCoarseTime(t))}}function modifyRank(e,t){const n=leaderboards[e],o=prompt("Modify Record (Step 1/2)\nEdit the name:",n[t-1].name);if(null===o)return;if(o!=n[t-1].name&&!checkName(o))return;const i=prompt("Modify Record (Step 2/2)\nEdit the time:\nLeave blank to edit the number of milliseconds directly",parseTime(n[t-1].score));if(null===i)return;let s;if(""==i){if(s=prompt("Modify Record (Step 2/2)\nEdit the number of milliseconds:",n[t-1].score),null===s)return;s=parseInt(s)}else s=timeStringToMillis(i);n.splice(t-1,1),pushRecord(parseInt(e[2]),o,s)}function removeRank(e,t){e.splice(t-1,1),sendUpdate()}function updateLeaderboard(e,t){const n=document.getElementById(e);n.innerHTML=`<h2 class="header">${id2titles[e]}</h2>`,n.innerHTML+=`<div class="header2">Time limit = <span id="time-limit-${e}"></span><span class="action" onclick="editTimeLimit('${e}')">[Edit]</span></div>`;var o=1;for(const{name:i,score:s}of t){const r=document.createElement("div");r.classList.add("record");const c=document.createElement("span");c.classList.add("record-rank"),c.innerText=o.toString();const a=document.createElement("span");a.classList.add("record-name"),a.innerText=i;const l=document.createElement("span");l.classList.add("record-time"),l.innerText=parseTime(s),r.appendChild(c),r.appendChild(a),r.appendChild(l);const d=document.createElement("span");d.classList.add("action"),d.innerText="[Mod]",d._rank=o,d.style.marginLeft="12px",d.onclick=t=>modifyRank(e,t.target._rank);const m=document.createElement("span");m.classList.add("action"),m.innerText="[Del]",m._rank=o,m.onclick=e=>{window.confirm(`Remove this record?\n${i}  -  ${s}`)&&removeRank(t,e.target._rank)},r.appendChild(d),r.appendChild(m),n.appendChild(r),o++}0==t.length&&(n.innerHTML+="<h2>empty</h2>"),n.style.backgroundColor="lightgreen",setTimeout(()=>n.style.backgroundColor="",300)}function coarseTimeToMillis(e){if(/^\d+$/.test(e))return parseInt(e,10);const t=e.match(/^(?:(\d+)m)?(?:(\d+)s)?$/);if(!t||void 0===t[1]&&void 0===t[2])return 0;let n=0;const o=t[1];void 0!==o&&(n+=60*parseInt(o,10)*1e3);const i=t[2];return void 0!==i&&(n+=1e3*parseInt(i,10)),n}function millisToCoarseTime(e){const t=(e=1e3*Math.floor(e/1e3))/1e3,n=Math.floor(t/60),o=t%60;let i="";return n>0&&(i+=`${n}m`),o>0?i+=`${o}s`:0===n&&0===o&&(i="0s"),i}function newTrial(e){trialOptions.ndisks=e,switchScreen(6)}function useAccessToken(){const e=prompt("Enter access token:");null!==e&&(e.length<4||(websocket.send("AUTH:token:"+e),localStorage.setItem("token",e)))}function customName(){const e=prompt("Enter name:");null!==e&&(trialOptions.name=e,switchScreen(4))}function editTimeLimit(e){const t=prompt("Enter new time limit\nExamples: '4m' / '2m30s' / '1000' (1000 millis)\nEnter '-1' to remove time limit",timeLimits[e]);if(null!==t&&0!=t.length)if("-1"==t)websocket.send(`@timeLimit:${e}:-1`);else{let n=coarseTimeToMillis(t);n=isNaN(n)?-1:n,websocket.send(`@timeLimit:${e}:${n}`)}}let timeLimits={lb4:-1,lb5:-1};var leaderboards={lb4:[],lb5:[]};const id2titles={lb4:"4 disks",lb5:"5 disks"};let statusTimeout=null;const trialOptions={name:"",ndisks:4,startTime:0,timerInterval:0,timeoutInterval:0,score:0,timeLimit:-1},websocket=(()=>{const e="https:"===window.location.protocol?"wss:":"ws:",t=window.location.host;return new WebSocket(`${e}//${t}/ws`)})();websocket.onopen=e=>{console.log("CONNECTED"),websocket.send("REPORT-ROLE:Input")},websocket.onclose=e=>{console.log("DISCONNECTED"),setStatus("Disconnected."),connectionTest()},websocket.onmessage=e=>{if(console.log(`RECEIVED: ${e.data}`),e.data.startsWith("@")){if(e.data.startsWith("@nclients:"))document.getElementById("nclients").innerText=e.data.slice(10);else if(e.data.startsWith("@meta:")){const t=JSON.parse(e.data.slice(6));timeLimits=t.timeLimits,updateTimeLimits()}}else if(e.data.startsWith("!"))"!reload-all"==e.data&&window.location.reload();else if(e.data.startsWith("AUTH:"))if("AUTH:required"==e.data){const e=localStorage.getItem("token");null==e?(switchScreen(999),setStatus("Server blocked input requests.")):(websocket.send(`AUTH:token:${e}`),setStatus("Authenticating ..."))}else"AUTH:success"==e.data?(setStatus("Permission granted.",!0),switchScreen(1)):"AUTH:failure"==e.data&&(localStorage.removeItem("token"),switchScreen(999),setStatus("Server blocked input requests."));else if(e.data.startsWith("DATA:")){const t=JSON.parse(e.data.slice(5));leaderboards=t,updateLeaderboards()}},websocket.onerror=e=>{console.log(`ERROR: ${e.data}`)},document.addEventListener("DOMContentLoaded",()=>{document.getElementById("connection-test").style.display="none",document.getElementById("new-trial-4").onclick=()=>newTrial(4),document.getElementById("new-trial-5").onclick=()=>newTrial(5),document.getElementById("refresh-all-button").onclick=()=>{websocket.send("refresh-all")},document.getElementById("reload-all-button").onclick=()=>{websocket.send("!reload-all")},document.getElementById("disconnect-all-button").onclick=()=>{websocket.send("!disconnect-all-output")},document.getElementById("manual-input-button").onclick=()=>{addRaw()},document.getElementById("reset-l4-button").onclick=()=>{leaderboards.lb4=[],sendUpdate()},document.getElementById("reset-l5-button").onclick=()=>{leaderboards.lb5=[],sendUpdate()},document.getElementById("toggle-l4-button").onclick=()=>{websocket.send("!toggle-l4")},document.getElementById("toggle-l5-button").onclick=()=>{websocket.send("!toggle-l5")},document.getElementById("adjust-height-button").onclick=()=>{adjustHeight()},document.getElementById("clear-animation-button").onclick=()=>{websocket.send("!regcancel")},document.getElementById("announce-button").onclick=()=>{announce()},document.getElementById("custom-name-button").onclick=customName,document.getElementById("timer-start-button").onclick=startTimer,document.getElementById("result-confirm-button").onclick=sendNewRecord,document.getElementById("result-cancel-button").onclick=()=>{websocket.send("!regcancel"),switchScreen(1)},document.getElementById("action-use-access-token").onclick=useAccessToken,document.querySelectorAll(".screen-1-button").forEach(e=>e.onclick=()=>{switchScreen(1)}),document.getElementById("name-confirm-button").onclick=()=>{trialOptions.name=document.getElementById("custom-name-input").value,""!=trialOptions.name?switchScreen(4):alert("Name cannot be empty!")},document.querySelectorAll("button[dangerous]").forEach(e=>{e._onclick=e.onclick,e.onclick=()=>{"yes!"==prompt("Are you sure? Type 'yes!' to confirm.")&&e._onclick()}}),switchScreen(1)});